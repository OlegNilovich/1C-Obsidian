ЗАНЯТИЕ 31. ВЗАИМОРАСЧЕТЫ В РАЗРЕЗЕ ПРОЕКТОВ
https://www.youtube.com/watch?v=o4WFZ6XKdsg&list=PLh28ogpgRJUPQDnx1uV9p19jLbpyBa3ua&index=31

ЗАНЯТИЕ 32. ОТЧЕТ ПО ВЗАИМОРАСЧЕТАМ В РАЗРЕЗЕ ПРОЕКТОВ
https://www.youtube.com/watch?v=JgR-qvp6mso&list=PLh28ogpgRJUPQDnx1uV9p19jLbpyBa3ua&index=32

---
### Задача:

Компания занимается оптовой торговлей. Взаиморасчеты с покупателями ведутся в разрезе проектов. Поступления денежных средств от покупателя отражается документом «Приход денег», отгрузка товаров документом «Расходная накладная».

Весь учет ведется в рублях и дополнительно в разных валютах в зависимости от проекта. Валюта указывается непосредственно в самом проекте. Для каждого проекта валюта может быть указана только одна.

Возникновение курсовых разниц при поставке и оплате не предполагается.

При проведении документа курс валюты должен быть взять на дату этого документа.

В документе «Приход денег» указывается контрагент и сумма платежа. Задолженности погашаются по проектам в порядке их даты оплаты (дата оплаты указывается в проекте). В случае, когда сумма платежа больше всех долгов по отгрузке, оставшаяся сумма в рублях зачитывается как аванс.

В документе «Расходная накладная» может быть указан только один проект (проект в реквизите шапки). При проведении документа «Расходная накладная» необходимо производить проверку авансов. В том случае, если аванс есть, необходимо его погасить. Оставшаяся сумма должна быть учтена как долг по проекту по отгрузке.

Учет остатков номенклатуры не ведется.

Необходимо создать отчет по состоянию взаиморасчетов на дату:

![[Pasted image 20241003144955.png]]

---
### Решение:

##### Справочник: **Валюты** 
Реквизиты: *КраткоеНаименование*

##### Справочник: **Проекты** 
Реквизиты: *Валюта* (СправочникСсылка.Валюты), *ДатаОплаты* (Дата)

##### Регистр сведений: **КурсыВалют** 
Измерения: *Валюта*
Ресурсы: *Курс*

##### Регистр накопления: **ОстаткиНоменклатуры** (Остатки)
Измерения: *Номенклатура*
Ресурсы: *Количество*

##### Регистр накопления: **Взаиморасчеты** (Остатки)
Измерения: *Контрагент*, *Валюта*, *Проект* (СправочникСсылка.Проекты)
Ресурсы: *Сумма*

##### Общий модуль: **ОбщегоНазначения** (Сервер)

```bsl
Функция ВалютаПроекта(Проект) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Проекты.Валюта КАК Валюта
		|ИЗ
		|	Справочник.Проекты КАК Проекты
		|ГДЕ
		|	Проекты.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Проект);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Валюта;	
	КонецЕсли;	
	
	Возврат Неопределено;
		
КонецФункции
```

##### Документ **РасходнаяНакладная**
Реквизиты: *Контрагент*, *Проект*, *СуммаПоДокументу*
Табличная часть: *СписокНоменклатуры*. Реквизиты:
- *Номенклатура* (СправочникСсылка.Номенклатура)
- *Количество*
- *Цена*
- *Сумма*

Модуль объекта:
```bsl

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Движения.Взаиморасчеты.Записывать = Истина;
	Движения.Записать();
	
	Движения.Взаиморасчеты.Записывать = Истина;
	
	Движение = Движения.Взаиморасчеты.ДобавитьПриход();
	Движение.Период = Дата;
	Движение.Контрагент = Контрагент;
	Движение.Проект = Проект;
	
	ВалютаПроекта = ОбщегоНазначения.ВалютаПроекта(Проект);
	Движение.Валюта = ВалютаПроекта;
	
	Движение.СуммаВВалюте = СуммаПоДокументу;
	
	Курс = РегистрыСведений.КурсыВалют.ПолучитьПоследнее(Дата, Новый Структура("Валюта", ВалютаПроекта)).Курс;
	Курс = ?(Курс = 0, 1, Курс);
	
	Движение.СуммаВРублях = СуммаПоДокументу * Курс;
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.Взаиморасчеты");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.УстановитьЗначение("Контрагент", Контрагент);
	ЭлементБлокировки.УстановитьЗначение("Проект", Справочники.Проекты.ПустаяСсылка());
	Блокировка.Заблокировать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	-ВзаиморасчетыОстатки.СуммаВРубляхОстаток КАК ОстатокАвансаВРублях,
		|	ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 1) КАК Курс,
		|	ВЫРАЗИТЬ(-ВзаиморасчетыОстатки.СуммаВРубляхОстаток / ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 1) КАК ЧИСЛО(15, 2)) КАК ОстатокАвансаВВалюте
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты.Остатки(
		|			&МоментВремени,
		|			Контрагент = &Контрагент
		|				И Проект = ЗНАЧЕНИЕ(Справочник.Проекты.ПустаяСсылка)) КАК ВзаиморасчетыОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&МоментВремени, Валюта = &Валюта) КАК КурсыВалютСрезПоследних
		|		ПО (ИСТИНА)";
	
	Запрос.УстановитьПараметр("Валюта", ВалютаПроекта);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	
	Если Выборка.ОстатокАвансаВВалюте > 0 Тогда
		
		СуммаПоДокументуВВалюте = СуммаПоДокументу;
		СуммаПоДокументуВРублях = СуммаПоДокументу * Выборка.Курс;
		
		Если Выборка.ОстатокАвансаВРублях >= СуммаПоДокументуВРублях Тогда
			СуммаСписанияАвансаВРублях = СуммаПоДокументуВРублях;
			СуммаСписанияАвансаВВалюте = СуммаПоДокументуВВалюте;
		Иначе
			СуммаСписанияАвансаВРублях = Выборка.ОстатокАвансаВРублях;
			СуммаСписанияАвансаВВалюте = Выборка.ОстатокАвансаВВалюте;
		КонецЕсли;
		
		Движение = Движения.Взаиморасчеты.ДобавитьПриход();
		Движение.Период = Дата;
		Движение.Контрагент = Контрагент;
		Движение.Проект = Справочники.Проекты.ПустаяСсылка();
		Движение.Валюта = Справочники.Валюты.РоссийскийРубль;
		Движение.СуммаВВалюте = СуммаСписанияАвансаВРублях;
		Движение.СуммаВРублях = СуммаСписанияАвансаВРублях;
		
		Движение = Движения.Взаиморасчеты.ДобавитьРасход();
		Движение.Период = Дата;
		Движение.Контрагент = Контрагент;
		Движение.Проект = Проект;
		Движение.Валюта = ВалютаПроекта;
		Движение.СуммаВВалюте = СуммаСписанияАвансаВВалюте;
		Движение.СуммаВРублях = СуммаСписанияАвансаВРублях;
		
	КонецЕсли;
	
КонецПроцедуры

```

##### Документ **ПриходДенег**
Реквизиты: *Контрагент*, *СуммаПлатежа*

Модуль объекта:
```bsl

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Движения.Взаиморасчеты.Записывать = Истина;
	Движения.Записать();
	
	Движения.Взаиморасчеты.Записывать = Истина;
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.Взаиморасчеты");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.УстановитьЗначение("Контрагент", Контрагент);
	Блокировка.Заблокировать();

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВзаиморасчетыОстатки.Контрагент КАК Контрагент,
		|	ВзаиморасчетыОстатки.Проект КАК Проект,
		|	ВзаиморасчетыОстатки.Валюта КАК Валюта,
		|	ВзаиморасчетыОстатки.СуммаВРубляхОстаток КАК СуммаВРубляхОстаток,
		|	ВзаиморасчетыОстатки.СуммаВВалютеОстаток КАК СуммаВВалютеОстаток
		|ПОМЕСТИТЬ втДолгиПокупателей
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты.Остатки(
		|			&МоментВремени,
		|			Контрагент = &Контрагент
		|				И Проект <> ЗНАЧЕНИЕ(Справочник.Проекты.ПустаяСсылка)) КАК ВзаиморасчетыОстатки
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Валюта
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втДолгиПокупателей.Контрагент КАК Контрагент,
		|	втДолгиПокупателей.Проект КАК Проект,
		|	втДолгиПокупателей.Валюта КАК Валюта,
		|	втДолгиПокупателей.СуммаВРубляхОстаток КАК СуммаВРубляхОстаток,
		|	втДолгиПокупателей.СуммаВВалютеОстаток КАК СуммаВВалютеОстаток,
		|	ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 1) КАК Курс,
		|	&Период КАК Период,
		|	втДолгиПокупателей.Проект.ДатаОплаты КАК ДатаОплаты
		|ИЗ
		|	втДолгиПокупателей КАК втДолгиПокупателей
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
		|				&Период,
		|				Валюта В
		|					(ВЫБРАТЬ
		|						втДолгиПокупателей.Валюта КАК Валюта
		|					ИЗ
		|						втДолгиПокупателей КАК втДолгиПокупателей)) КАК КурсыВалютСрезПоследних
		|		ПО втДолгиПокупателей.Валюта = КурсыВалютСрезПоследних.Валюта
		|
		|УПОРЯДОЧИТЬ ПО
		|	ДатаОплаты";
	
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	Запрос.УстановитьПараметр("Период", Дата);
	
	СуммаКПогашениюВРублях = СуммаПлатежа;
	
	РезультатЗапроса = Запрос.Выполнить();
	Если Не РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() И СуммаКПогашениюВРублях > 0 Цикл
			
			СуммаВРублях = Мин(СуммаКПогашениюВРублях, Выборка.СуммаВРубляхОстаток);
			
			Если СуммаВРублях = Выборка.СуммаВРубляхОстаток Тогда
				СуммаВВалюте = Выборка.СуммаВВалютеОстаток;
			Иначе
				СуммаВВалюте = Окр(СуммаВРублях / Выборка.Курс, 2);
				Если СуммаВВалюте = Выборка.СуммаВВалютеОстаток Тогда
					СуммаВВалюте = СуммаВВалюте - 0.01;
				КонецЕсли;
			КонецЕсли;
			
			Если СуммаВВалюте > 0 Тогда
				Движение = Движения.Взаиморасчеты.ДобавитьРасход();
				ЗаполнитьЗначенияСвойств(Движение, Выборка);
				Движение.СуммаВРублях = СуммаВРублях;
				Движение.СуммаВВалюте = СуммаВВалюте;
				
				СуммаКПогашениюВРублях = СуммаКПогашениюВРублях - СуммаВРублях;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	// авансы
	Если СуммаКПогашениюВРублях > 0 Тогда
		Движение = Движения.Взаиморасчеты.ДобавитьРасход();
		Движение.Период = Дата;
		Движение.Контрагент = Контрагент;
		Движение.Проект = Справочники.Проекты.ПустаяСсылка();
		Движение.Валюта = Справочники.Валюты.РоссийскийРубль;
		Движение.СуммаВВалюте = СуммаКПогашениюВРублях;
		Движение.СуммаВРублях = СуммаКПогашениюВРублях;
	КонецЕсли;
		
КонецПроцедуры

```
