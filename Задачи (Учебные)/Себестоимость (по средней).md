#ЗАПРОСЫ 

```bsl
//Шаг 1. Получить остатки по регистру "ПартииТоваровНаСкладах"
Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	РасходнаяНакладнаяТовары.Номенклатура КАК				Номенклатура,
|	СУММА(РасходнаяНакладнаяТовары.Количество) КАК 	Количество,
|	СУММА(РасходнаяНакладнаяТовары.СуммаВсего) КАК   СуммаВсего
|ПОМЕСТИТЬ ВТ_Товары
|ИЗ
|	Документ.РасходнаяНакладная.Товары КАК РасходнаяНакладнаяТовары
|ГДЕ
|	РасходнаяНакладнаяТовары.Ссылка = &Ссылка
|
|СГРУППИРОВАТЬ ПО
|	РасходнаяНакладнаяТовары.Номенклатура
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ПартииТоваровНаСкладахОстатки.Номенклатура КАК			Номенклатура,
|	ПартииТоваровНаСкладахОстатки.КоличествоОстаток КАК		КоличествоОстаток,
|	ПартииТоваровНаСкладахОстатки.СтоимостьОстаток КАК		СтоимостьОстаток
|ПОМЕСТИТЬ ВТ_Остатки
|ИЗ
|	РегистрНакопления.ПартииТоваровНаСкладах.Остатки(
|			&МоментВремени,
|			(Номенклатура, Склад, Организация) В
|				(ВЫБРАТЬ
|					ВТ_Товары.Номенклатура КАК Номенклатура,
|					&Склад КАК Склад,
|					&Организация КАК Организация
|				ИЗ
|					ВТ_Товары КАК ВТ_Товары)) КАК ПартииТоваровНаСкладахОстатки
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ВТ_Товары.Номенклатура КАК									Номенклатура,
|	ВТ_Товары.Количество КАК										КоличествоВДокументе,
|	ЕСТЬNULL(ВТ_Остатки.КоличествоОстаток, 0) КАК		КоличествоОстаток,
|	ЕСТЬNULL(ВТ_Остатки.СтоимостьОстаток, 0) КАК		СтоимостьОстаток,
|	ВТ_Товары.СуммаВсего КАК										СуммаВсего
|ИЗ
|	ВТ_Товары КАК ВТ_Товары
|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Остатки КАК ВТ_Остатки
|		ПО ВТ_Товары.Номенклатура = ВТ_Остатки.Номенклатура";
Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
Запрос.УстановитьПараметр("Организация", Организация);
Запрос.УстановитьПараметр("Склад", Склад);
Запрос.УстановитьПараметр("Ссылка", Ссылка);

//Шаг 2. установка явной управляемой блокировки
Блокировка = Новый БлокировкаДанных;
ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ПартииТоваровНаСкладах");
ЭлементБлокировки.УстановитьЗначение("Организация", Организация);
ЭлементБлокировки.УстановитьЗначение("Склад", Склад);
ЭлементБлокировки.ИсточникДанных = Товары;
ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Номенклатура", "Номенклатура");
Блокировка.Заблокировать();

//Шаг 3.  Сформировать движения в регистрах
Движения.ПартииТоваровНаСкладах.Записывать = Истина;
Движения.Хозрасчетный.Записывать = Истина;
Движения.Продажи.Записывать = Истина;

Выборка = Запрос.Выполнить().Выбрать();
Пока Выборка.Следующий() Цикл
	
	НоваяЗапись = Движения.ПартииТоваровНаСкладах.ДобавитьРасход();
	НоваяЗапись.Период = Дата;                      
	НоваяЗапись.Организация = Организация;
	НоваяЗапись.Склад = Склад;
	НоваяЗапись.Номенклатура = Выборка.Номенклатура;
	НоваяЗапись.Количество = Выборка.КоличествоВДокументе;
	
	//2.1 Расчет стоимости единицы
	Если Выборка.КоличествоОстаток = 0 Тогда
		СебестоимостьЕдиницы = 0;
	Иначе
		СебестоимостьЕдиницы = Выборка.СтоимостьОстаток / Выборка.КоличествоОстаток;
	КонецЕсли;	
	
	//2.2 Расчет стоимости списания			
	НоваяЗапись.Стоимость = Выборка.КоличествоВДокументе * СебестоимостьЕдиницы;
	
	//Продажи
	НоваяЗапись = Движения.Продажи.Добавить();
	НоваяЗапись.Период = Дата;
	НоваяЗапись.Организация = Организация;
	НоваяЗапись.Контрагент = Контрагент; 
	НоваяЗапись.Ответственный = Ответственный;
	НоваяЗапись.Номенклатура = Выборка.Номенклатура;
	НоваяЗапись.Количество = Выборка.КоличествоВДокументе;
	НоваяЗапись.Сумма = Выборка.СуммаВсего;
	НоваяЗапись.Себестоимость = Выборка.КоличествоВДокументе * СебестоимостьЕдиницы;
	
	//Бухгалтерские проводки
	Проводка = Движения.Хозрасчетный.Добавить();
	Проводка.Период = Дата;
	Проводка.Организация = Организация;
	Проводка.СчетДт = ПланыСчетов.Хозрасчетный.Себестоимость;
	Проводка.СчетКт = ПланыСчетов.Хозрасчетный.Товары;
	Проводка.СубконтоКт[ВидСубконто_Товары] = Выборка.Номенклатура;
	Проводка.СубконтоКт[ВидСубконто_Склады] = Склад;  
	Проводка.КоличествоКт = Выборка.КоличествоВДокументе;
	Проводка.Сумма = Выборка.КоличествоВДокументе * СебестоимостьЕдиницы;
	
КонецЦикла;
```