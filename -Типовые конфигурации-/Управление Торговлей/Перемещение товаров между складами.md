#TODO 

![[Pasted image 20241126235721.png]]

```bsl

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СкладОтправительПриИзменении(Элемент)
	ЗаполнитьПоОстаткамНаСервере();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаполнитьПоОстаткам(Команда)
	ЗаполнитьПоОстаткамНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СоздатьДокументПеремещения(Команда)
	
	Если Объект.СкладОтправитель = Объект.СкладПолучатель Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Склад отправителя должен отличаться от склада получателя");
		Возврат;
	КонецЕсли;
	
	Если СписокНоменклатуры.Количество() = 0 Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Список номенклатуры пуст!");
		Возврат;
	КонецЕсли;
	
	ДокПеремещения = СоздатьДокументПеремещенияНаСервере();
	
	Текст		= "Документ успешно создан";
	Нажатие	= ПолучитьНавигационнуюСсылку(ДокПеремещения);
	Пояснение = ДокПеремещения;
	Картинка	= БиблиотекаКартинок.Оповещения;
	Статус		= СтатусОповещенияПользователя.Важное;
	ПоказатьОповещениеПользователя(Текст, Нажатие, Пояснение, Картинка, Статус, Текст);
	
	ПараметрыФормы = Новый Структура("Ключ", ДокПеремещения);
	ОткрытьФорму("Документ.ПеремещениеТоваров.Форма.ФормаДокумента", ПараметрыФормы);
	
КонецПроцедуры

&НаСервере
Функция СоздатьДокументПеремещенияНаСервере()
	
	ДокПеремещения = Документы.ПеремещениеТоваров.СоздатьДокумент();
	ДокПеремещения.Дата						= ТекущаяДата();
	ДокПеремещения.Организация				= Объект.Организация;
	ДокПеремещения.СкладОтправитель			= Объект.СкладОтправитель;
	ДокПеремещения.СкладПолучатель			= Объект.СкладПолучатель;
	ДокПеремещения.Ответственный        		= Пользователи.ТекущийПользователь();
	ДокПеремещения.Автор                       		= Пользователи.ТекущийПользователь();
	ДокПеремещения.Статус						= Перечисления.СтатусыПеремещенийТоваров.Принято;
	ДокПеремещения.ХозяйственнаяОперация	= Перечисления.ХозяйственныеОперации.ПеремещениеТоваров;
	ДокПеремещения.ВариантПриемкиТоваров	= Перечисления.ВариантыПриемкиТоваров.РазделенаПоЗаказамИНакладным;
	
	Для Каждого ТекСтрока Из СписокНоменклатуры Цикл
		НоваяСтрока = ДокПеремещения.Товары.Добавить();
		НоваяСтрока.Номенклатура			= ТекСтрока.Номенклатура;
		НоваяСтрока.Упаковка				= ТекСтрока.ЕдиницаИзмерения;
		НоваяСтрока.Количество				= ТекСтрока.Количество;
		НоваяСтрока.КоличествоУпаковок	= ТекСтрока.Количество;
	КонецЦикла;
	
	ДокПеремещения.Записать();
	
	Возврат ДокПеремещения.Ссылка;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьПоОстаткамНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Склад", Объект.СкладОтправитель);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК						Номенклатура,
	|	ТоварыНаСкладахОстатки.Номенклатура.ЕдиницаИзмерения КАК	ЕдиницаИзмерения,
	|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК					Количество
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(, Склад = &Склад) КАК ТоварыНаСкладахОстатки";
	
	СписокНоменклатуры.Очистить();
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = СписокНоменклатуры.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

```