ЗАНЯТИЕ 12. РАСЧЕТ СЕБЕСТОИМОСТИ ПО СРЕДНЕЙ И ФИФО
https://www.youtube.com/watch?v=Y6e01yTi9uE&list=PLh28ogpgRJUPQDnx1uV9p19jLbpyBa3ua&index=12

ЗАНЯТИЕ 13. ОТЧЕТ "ДВИЖЕНИЯ ТОВАРОВ"
https://www.youtube.com/watch?v=82WX8eBHo3U&list=PLh28ogpgRJUPQDnx1uV9p19jLbpyBa3ua&index=13

---
### Задача:

Компания занимается оптовой торговлей. Поступление товаров отражается документом «Приходная накладная», продажа - «Расходная накладная». Помимо продажи товара, могут оказываться дополнительные услуги, например по доставке. И услуги и товары указываются в одной табличной части.

Складской учет товаров не ведется.

Списание себестоимости должно быть в зависимости от принятого на момент проведения документа значения учетной политики. Метод списания себестоимости либо по FIFO, либо по средней. Учетная политика может меняться каждый месяц, её изменение фиксируется соответствующим документом. Например:

01.01.2012 Учетная политика № 1 Списание по FIFO
05.01.2012 Прих. накладная № 1 Куртка 1 шт. 1800р. (стоимость закупки)
10.01.2012 Прих. накладная № 2 Куртка 1 шт. 1000р. (стоимость закупки)
15.01.2012 Прих Накладная № 3 Куртка 1 шт. 2000р. (стоимость закупки)
25.01.2012 Расх. накладная № 1 Куртка 1 шт. 1800р. (себестоимость)
01.02.2012 Учетная политика № 2 списание по средней
07.02.2012 Расх. накладная № 2 Куртка 1 шт. 1500р. (себестоимость)

Считается, что документы задним числом не вводятся, но старые документы могут неоперативно перепроводиться.

Необходимо построить отчет по движениям товаров за период:
![[Pasted image 20240930111749.png]]

---
### Решение:
##### Регистр накопления: **ОстаткиНоменклатуры**
Измерения: *Номенклатура*, *Партия*
Ресурсы: *Количество*, *Стоимость*

##### Регистр сведений: **УчетнаяПолитика**
Измерения: 
Ресурсы: *МетодСписанияСебестоимости*

##### Документ **НазначениеУчетнойПолитики**
Реквизиты: *МетодСписанияСебестоимости*

Модуль объекта:
```bsl
Процедура ОбработкаПроведения(Отказ, Режим)
	
	СтарыйМетодСписанияСебестоимости = УчетнаяПолитика.МетодСписанияСебестоимости(Дата - 1);
	Если СтарыйМетодСписанияСебестоимости = МетодСписанияСебестоимости Тогда
		Отказ = Истина;
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Метод списания себестоимости соответствует уже установленному методу";
		Сообщение.Сообщить();
		
		Возврат;
	КонецЕсли;
	
	// регистр УчетнаяПолитика
	Движения.УчетнаяПолитика.Записывать = Истина;
	Движение = Движения.УчетнаяПолитика.Добавить();
	Движение.Период = Дата;
	Движение.МетодСписанияСебестоимости = МетодСписанияСебестоимости;
	
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	Движения.Записать();
	
	Если МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика.Среднее Тогда
			
		Движения.ОстаткиНоменклатуры.Записывать = Истина;
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ОстаткиНоменклатуры");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		Блокировка.Заблокировать();

		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
			|	ОстаткиНоменклатурыОстатки.Партия КАК Партия,
			|	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК Количество,
			|	ОстаткиНоменклатурыОстатки.СтоимостьОстаток КАК Стоимость
			|ИЗ
			|	РегистрНакопления.ОстаткиНоменклатуры.Остатки(&МоментВремени, ) КАК ОстаткиНоменклатурыОстатки
			|ИТОГИ
			|	СУММА(Количество),
			|	СУММА(Стоимость)
			|ПО
			|	Номенклатура";
		
		Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаНоменклатура = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока ВыборкаНоменклатура.Следующий() Цикл
			Движение = Движения.ОстаткиНоменклатуры.ДобавитьПриход();
			ЗаполнитьЗначенияСвойств(Движение, ВыборкаНоменклатура);
			Движение.Период = Дата;
		
			ВыборкаДетальныеЗаписи = ВыборкаНоменклатура.Выбрать();	
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл		
				Движение = Движения.ОстаткиНоменклатуры.ДобавитьРасход();
				ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);
				Движение.Период = Дата;			
			КонецЦикла;
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры
```

##### Документ **ПриходнаяНакладная**
Реквизиты: *СуммаПоДокументу*
Табличная часть: *СписокНоменклатуры*. Реквизиты:
- *Номенклатура*
- *Количество*
- *Цена*
- *Сумма*

Модуль объекта:
```bsl
Процедура ОбработкаПроведения(Отказ, Режим)

	МетодСписанияСебестоимости = УчетнаяПолитика.МетодСписанияСебестоимости(Дата);
	
	Если МетодСписанияСебестоимости = Неопределено Тогда
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не указан метод списания себестоимости в учетной политике";
		Сообщение.Сообщить();
		
		Отказ = Истина;
		Возврат;
		
	КонецЕсли;
	
	Если МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика.Среднее Тогда
		Партия = Документы.ПриходнаяНакладная.ПустаяСсылка();
	Иначе
		Партия = Ссылка;
	КонецЕсли;
	
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
		|	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
		|	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
		|ИЗ
		|	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
		|ГДЕ
		|	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Движение = Движения.ОстаткиНоменклатуры.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.Номенклатура = Выборка.Номенклатура;
		Движение.Партия = Партия;
		Движение.Количество = Выборка.Количество;
		Движение.Стоимость = Выборка.Сумма;
	КонецЦикла;
	 
КонецПроцедуры
```

##### Документ **РасходнаяНакладная**
Реквизиты: *СуммаПоДокументу*
Табличная часть: *СписокНоменклатуры*. Реквизиты:
- *Номенклатура*
- *Количество*
- *Цена*
- *Сумма*

Модуль объекта:
```bsl
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	МетодСписанияСебестоимости = УчетнаяПолитика.МетодСписанияСебестоимости(Дата);
	
	Если МетодСписанияСебестоимости = Неопределено Тогда
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не указан метод списания себестоимости в учетной политике";
		Сообщение.Сообщить();
		
		Отказ = Истина;
		Возврат;

	КонецЕсли;
	
	// удаление движения
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	Движения.Записать();
	
	// взвели флаг
	Движения.ОстаткиНоменклатуры.Записывать = Истина;	
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ОстаткиНоменклатуры");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.ИсточникДанных = СписокНоменклатуры;
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Номенклатура", "Номенклатура");
	Блокировка.Заблокировать();
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
	|	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
	|ПОМЕСТИТЬ втТЧТовары
	|ИЗ
	|	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
	|ГДЕ
	|	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втТЧТовары.Номенклатура КАК Номенклатура,
	|	втТЧТовары.Номенклатура.Представление КАК НоменклатураПредставление,
	|	втТЧТовары.Количество КАК Количество,
	|	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.СтоимостьОстаток, 0) КАК СтоимостьОстаток,
	|	ОстаткиНоменклатурыОстатки.Партия КАК Партия
	|ИЗ
	|	втТЧТовары КАК втТЧТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(
	|				&МоментВремени,
	|				Номенклатура В
	|						(ВЫБРАТЬ
	|							втТЧТовары.Номенклатура КАК Номенклатура
	|						ИЗ
	|							втТЧТовары КАК втТЧТовары)) КАК ОстаткиНоменклатурыОстатки
	|		ПО втТЧТовары.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОстаткиНоменклатурыОстатки.Партия.МоментВремени
	|ИТОГИ
	|	МАКСИМУМ(Количество),
	|	СУММА(КоличествоОстаток)
	|ПО
	|	Номенклатура";
	
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаНоменклатура = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаНоменклатура.Следующий() Цикл
		
		Если ВыборкаНоменклатура.Количество > ВыборкаНоменклатура.КоличествоОстаток Тогда
			
			Отказ = Истина;
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = СтрШаблон("Недостаточно товара %1 в количестве %2", 
			ВыборкаНоменклатура.НоменклатураПредставление, 
			ВыборкаНоменклатура.Количество - ВыборкаНоменклатура.КоличествоОстаток);
			Сообщение.Сообщить();
			
		КонецЕсли;
		
		Если Отказ Тогда
			Продолжить;
		КонецЕсли;
		
		КоличествоСписать = ВыборкаНоменклатура.Количество;
		
		ВыборкаДетальныеЗаписи = ВыборкаНоменклатура.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() И КоличествоСписать < 0 Цикл
			
			Количество = Мин(КоличествоСписать, ВыборкаДетальныеЗаписи.КоличествоОстаток);
			
			Если Количество = ВыборкаДетальныеЗаписи.КоличествоОстаток Тогда
				Себестоимость = ВыборкаДетальныеЗаписи.СтоимостьОстаток;
			Иначе
				Себестоимость = Количество / ВыборкаДетальныеЗаписи.КоличествоОстаток * 
				ВыборкаДетальныеЗаписи.СтоимостьОстаток;
			КонецЕсли;
			
			Движение = Движения.ОстаткиНоменклатуры.ДобавитьРасход();
			Движение.Период = Дата;
			Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
			Движение.Партия = ВыборкаДетальныеЗаписи.Партия;
			Движение.Количество = Количество;
			Движение.Стоимость = Себестоимость;
			
			КоличествоСписать = КоличествоСписать - Количество;
			
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры
```